<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Invoice Generator Dashboard</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #ddd;
      margin: 0 5px;
      border-radius: 5px;
      text-decoration: none;
      color: black;
    }
    .tab.active {
      background: #007bff;
      color: white;
    }
    .dashboard {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border: 1px solid #ccc;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .dashboard-header select, .dashboard-header button {
      padding: 5px;
      margin: 5px;
    }
    .search-container {
      margin-bottom: 15px;
    }
    .search-container input {
      padding: 5px;
      width: 200px;
      margin-right: 10px;
    }
    .search-container button {
      padding: 5px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .search-container #clear-search-btn {
      background: #ff4d4d;
    }
    .filter-container {
      margin-bottom: 15px;
    }
    .filter-container select, .filter-container input {
      padding: 5px;
      margin-right: 10px;
    }
    .stats {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .stat-box {
      width: 18%;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: center;
      background: #f9f9f9;
    }
    .stat-box.monthly { background: #e6f7ff; }
    .stat-box.yearly { background: #fffbe6; }
    .stat-box h3 { margin: 0; font-size: 16px; }
    .stat-box p { margin: 5px 0 0; font-size: 20px; font-weight: bold; }
    .download-report-btn {
      display: block;
      width: 200px;
      margin: 20px auto;
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .invoice-list {
      margin-top: 20px;
    }
    .invoice-list table {
      width: 100%;
      border-collapse: collapse;
    }
    .invoice-list th, .invoice-list td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .invoice-list th {
      background-color: #f2f2f2;
    }
    .action-btn, .cancel-btn, .edit-btn, .gmail-btn {
      padding: 5px 10px;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 5px;
    }
    .action-btn { background: #007bff; }
    .cancel-btn { background: #ff8c00; }
    .edit-btn { background: #4CAF50; }
    .gmail-btn { background: #D44638; }
    .canceled-row { color: #888; }
    #pdf-container {
      display: none;
    }
    @media screen and (max-width: 768px) {
      .dashboard { padding: 10px; }
      .stat-box { width: 48%; }
      .search-container input { width: 150px; }
      .filter-container select, .filter-container input { width: 100px; }
      table { font-size: 8px; }
    }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" data-tab="services">Dashboard</div>
    <a class="tab" href="invoice.html">Purchase Records</a>
    <a class="tab" href="create-invoice.html">Create Invoice</a>
    <a class="tab" href="invoice-preview.html">Invoice Preview</a>
  </div>

  <div class="dashboard" id="services">
    <h2>Dashboard</h2>
    <div class="dashboard-header">
      <div>
        <label for="month-select">Select Month:</label>
        <select id="month-select">
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6" selected>June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
        <label for="year-select">Select Year:</label>
        <select id="year-select"></select>
        <label for="fy-select">Select Financial Year:</label>
        <select id="fy-select"></select>
        <button id="filter-btn">Filter</button>
      </div>
    </div>
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search by invoice no, customer name, or date">
      <button id="search-btn">Search</button>
      <button id="clear-search-btn">Clear</button>
    </div>
    <h3>Month-wise:</h3>
    <div class="stats">
      <div class="stat-box monthly">
        <h3>Invoices (June-2025)</h3>
        <p id="monthly-value">0</p>
      </div>
      <div class="stat-box monthly">
        <h3>Subtotal (June-2025)</h3>
        <p id="subtotal-monthly">Rs. 0</p>
      </div>
      <div class="stat-box monthly">
        <h3>GST Total (June-2025)</h3>
        <p id="gst-monthly">Rs. 0</p>
      </div>
      <div class="stat-box monthly">
        <h3>Earnings (June-2025)</h3>
        <p id="earnings-monthly">Rs. 0</p>
      </div>
      <div class="stat-box monthly">
        <h3>Pending (Rs.)</h3>
        <p id="pending-monthly">Rs. 0</p>
      </div>
    </div>
    <h3>Yearly:</h3>
    <div class="stats">
      <div class="stat-box yearly">
        <h3>Invoices (2024-2025)</h3>
        <p id="yearly-value">0</p>
      </div>
      <div class="stat-box yearly">
        <h3>Subtotal (2024-2025)</h3>
        <p id="subtotal-yearly">Rs. 0</p>
      </div>
      <div class="stat-box yearly">
        <h3>GST Total (2024-2025)</h3>
        <p id="gst-yearly">Rs. 0</p>
      </div>
      <div class="stat-box yearly">
        <h3>Earnings (2024-2025)</h3>
        <p id="earnings-yearly">Rs. 0</p>
      </div>
      <div class="stat-box yearly">
        <h3>Pending (Rs.)</h3>
        <p id="pending-yearly">0</p>
      </div>
    </div>
    <div class="filter-container">
      <select id="filter-day">
        <option value="">All Days</option>
        <!-- Days will be populated dynamically -->
      </select>
      <select id="filter-month">
        <option value="">All Months</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      <select id="filter-year">
        <option value="">All Years</option>
        <!-- Years will be populated dynamically -->
      </select>
      <button id="apply-filter-btn">Apply Filter</button>
      <button id="clear-filter-btn">Clear Filters</button>
    </div>
    <h3>Invoice List</h3>
    <div class="invoice-list">
      <table>
        <thead>
          <tr>
            <th>Invoice No</th>
            <th>Date</th>
            <th>Customer Name</th>
            <th>Total (INR)</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="invoice-list-body"></tbody>
      </table>
    </div>
    <button class="download-report-btn" onclick="downloadReport()">Download Report</button>
    <div id="pdf-container"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAT3oqplHoUuZrDNpnZbQ-hoUChLLEdmV4",
      authDomain: "saas-restaurant-vardhan.firebaseapp.com",
      projectId: "saas-restaurant-vardhan",
      storageBucket: "saas-restaurant-vardhan.appspot.com",
      messagingSenderId: "1019077493371",
      appId: "1:1019077493371:web:2c92f2c902e34b05c358de"
    };

    let db;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Error initializing Firebase:', error);
      alert('Failed to initialize Firebase. Please check your configuration.');
    }

    // Utility: Sanitize HTML to prevent XSS
    function sanitizeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    // Utility: Generate invoice HTML for PDF
    function generateInvoiceHTML(invoiceData, totals) {
      const isTaxInvoice = invoiceData.invoiceType === 'tax' || !invoiceData.invoiceType;
      const items = invoiceData.items || [];
      let html = `
        <style>
          body { font-family: Arial, sans-serif; font-size: 10px; }
          .invoice-page { width: 210mm; padding: 10mm; border: 1px solid #000; }
          .header { display: flex; justify-content: space-between; }
          .title { font-size: 20px; font-weight: bold; }
          .section { margin-bottom: 10px; }
          .bold { font-weight: bold; }
          table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
          th, td { border: 1px solid #000; padding: 4px; text-align: left; }
          th { background: #f8f8f8; }
          .bank-section { display: flex; font-size: 10px; margin-top: 15px; }
          .logo { height: 40px; }
          .timestamp { font-size: 10px; color: #555; text-align: right; margin-bottom: 10px; }
        </style>
        <div class="invoice-page">
          <div class="timestamp">Generated on: ${formatTimestamp(new Date())}</div>
          <div class="header">
            <div>
              <p class="title">${isTaxInvoice ? 'TAX INVOICE' : 'INVOICE'}</p>
              <div class="section">
                <p><span class="bold">Invoice Date:</span> ${sanitizeHTML(invoiceData.date || 'N/A')}</p>
                <p><span class="bold">Invoice No:</span> ${sanitizeHTML(invoiceData.invoiceNo || 'N/A')}</p>
                <p><span class="bold">Place of Supply:</span> ${sanitizeHTML(invoiceData.placeOfSupply || 'N/A')}</p>
              </div>
              <div class="section">
                <p><span class="bold">Name:</span> ${sanitizeHTML(invoiceData.customerName || 'N/A')}</p>
                <p><span class="bold">Address:</span> ${sanitizeHTML(invoiceData.customerAddress || 'N/A')}</p>
                <p><span class="bold">GSTIN:</span> ${sanitizeHTML(invoiceData.customerGSTIN || 'N/A')}</p>
                <p><span class="bold">STATE:</span> ${sanitizeHTML(invoiceData.customerState || 'N/A')}</p>
              </div>
            </div>
            <div style="text-align: right;">
              <img src="image.png" class="logo" alt="Tripzetta Logo" onerror="this.style.display='none'">
              <div>
                <p><strong>GSTIN:</strong> 07APDPA8620A1ZL</p>
                <p><strong>PAN:</strong> APDPA8620A</p>
                <p><strong>Regd. Address:</strong> 408 4th Floor Devika Tower Nehru Place New Delhi</p>
                <p><strong>Contact:</strong> +919650485130</p>
              </div>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Service Description</th>
                ${isTaxInvoice ? `
                  <th>SAC Code</th>
                  <th>Tax Type</th>
                ` : ''}
                <th>Taxable Value</th>
                <th>SGST%</th>
                <th>SGST Amount</th>
                <th>CGST%</th>
                <th>CGST Amount</th>
                <th>IGST%</th>
                <th>IGST Amount</th>
                <th>Total (INR)</th>
              </tr>
            </thead>
            <tbody>
      `;
      let itemIndex = 0;
      items.forEach(item => {
        const taxableValue = parseFloat(item.taxableValue) || 0;
        const sgstRate = parseFloat(item.sgstRate) || 0;
        const cgstRate = parseFloat(item.cgstRate) || 0;
        const igstRate = parseFloat(item.igstRate) || 0;
        const sgstAmt = taxableValue * sgstRate / 100 || 0;
        const cgstAmt = taxableValue * cgstRate / 100 || 0;
        const igstAmt = taxableValue * igstRate / 100 || 0;
        const total = taxableValue + sgstAmt + cgstAmt + igstAmt;
        html += `
          <tr>
            <td>${itemIndex + 1}</td>
            <td>${sanitizeHTML(item.description || 'N/A').replace(/\n/g, '<br>')}</td>
            ${isTaxInvoice ? `
              <td>${sanitizeHTML(item.sacCode || 'N/A')}</td>
              <td>${sanitizeHTML(item.taxType || 'N/A')}</td>
            ` : ''}
            <td>${taxableValue.toFixed(2)}</td>
            <td>${sgstRate.toFixed(2)}</td>
            <td>${sgstAmt.toFixed(2)}</td>
            <td>${cgstRate.toFixed(2)}</td>
            <td>${cgstAmt.toFixed(2)}</td>
            <td>${igstRate.toFixed(2)}</td>
            <td>${igstAmt.toFixed(2)}</td>
            <td>${total.toFixed(2)}</td>
          </tr>
        `;
        itemIndex++;
        if (item.subItems && Array.isArray(item.subItems)) {
          item.subItems.forEach(subItem => {
            const subTaxableValue = parseFloat(subItem.taxableValue) || 0;
            const subSgstAmt = subTaxableValue * sgstRate / 100 || 0;
            const subCgstAmt = subTaxableValue * cgstRate / 100 || 0;
            const subIgstAmt = subTaxableValue * igstRate / 100 || 0;
            const subTotal = subTaxableValue + subSgstAmt + subCgstAmt + subIgstAmt;
            html += `
              <tr>
                <td></td>
                <td>${sanitizeHTML(subItem.description || 'N/A').replace(/\n/g, '<br>')}</td>
                ${isTaxInvoice ? `
                  <td></td>
                  <td></td>
                ` : ''}
                <td>${subTaxableValue.toFixed(2)}</td>
                <td>${sgstRate.toFixed(2)}</td>
                <td>${subSgstAmt.toFixed(2)}</td>
                <td>${cgstRate.toFixed(2)}</td>
                <td>${subCgstAmt.toFixed(2)}</td>
                <td>${igstRate.toFixed(2)}</td>
                <td>${subIgstAmt.toFixed(2)}</td>
                <td>${subTotal.toFixed(2)}</td>
              </tr>
            `;
            itemIndex++;
          });
        }
      });
      html += `
              <tr>
                <td colspan="${isTaxInvoice ? 11 : 9}" style="text-align:right;font-weight:bold;">Total Invoice Value</td>
                <td>${(totals.totalBeforeTax + totals.totalSGST + totals.totalCGST + totals.totalIGST).toFixed(2)}</td>
              </tr>
            </tbody>
          </table>
          <div class="bank-section">
            <div style="width: 60%; border: 1px solid #000; padding: 5px;">
              <p><strong>Bank Details:</strong></p>
              <p>Beneficiary Name: TRIPZETTA</p>
              <p>Bank Name: YES BANK</p>
              <p>Branch: EAST OF KAILASH, New Delhi</p>
              <p>IFSC CODE: YESB0000514</p>
              <p>Current Account No: 051463700000043</p>
            </div>
            <div style="width: 40%; border: 1px solid #000; border-left: none;">
              <table style="width:100%; border-collapse: collapse;">
                <tr><td style="border: 1px solid #000; padding: 4px;">Total Amount Before Tax</td><td style="border: 1px solid #000; padding: 4px;">${totals.totalBeforeTax.toFixed(2)}</td></tr>
                <tr><td style="border: 1px solid #000; padding: 4px;">Add: SGST @ 9%</td><td style="border: 1px solid #000; padding: 4px;">${totals.totalSGST.toFixed(2)}</td></tr>
                <tr><td style="border: 1px solid #000; padding: 4px;">Add: CGST @ 9%</td><td style="border: 1px solid #000; padding: 4px;">${totals.totalCGST.toFixed(2)}</td></tr>
                <tr><td style="border: 1px solid #000; padding: 4px;">Add: IGST @ 18%</td><td style="border: 1px solid #000; padding: 4px;">${totals.totalIGST.toFixed(2)}</td></tr>
                <tr><td style="border: 1px solid #000; padding: 4px;">Rounding</td><td style="border: 1px solid #000; padding: 4px;">${totals.rounding.toFixed(2)}</td></tr>
                <tr><td style="border: 1px solid #000; padding: 4px;"><strong>Total Invoice Value</strong></td><td style="border: 1px solid #000; padding: 4px;">${totals.roundedTotal.toFixed(2)}</td></tr>
              </table>
            </div>
          </div>
          <div style="width: 100%; border: 1px solid #000; border-top: none; padding: 4px;">
            <strong>Total Invoice Value (In Words):</strong> ${sanitizeHTML(numberToWords(totals.roundedTotal))}
          </div>
          <div style="width: 100%; border: 1px solid #000; border-top: none; padding: 4px;">
            <p><strong>Terms & Conditions:</strong></p>
            <ul style="margin: 4px 0 4px 15px; padding-left: 0;">
              <li>CHEQUE/NEFT/RTGS should be in favour of TRIPZETTA</li>
              <li>Any refunds or claims are subject to the cancellation policy of the booking as per rules.</li>
              <li>All disputes are subject to jurisdiction of Delhi courts.</li>
              <li>Interest @ 18% p.a. will be charged on overdue bills.</li>
            </ul>
          </div>
          <div style="width: 100%; border: 1px solid #000; border-top: none; display: flex; justify-content: flex-end; padding: 4px;">
            <div style="text-align: right;">
              <p>For TRIPZETTA</p>
              <img src="sign.png" class="logo" alt="Tripzetta Signature" onerror="this.style.display='none'">
              <p>Authorised Signatory</p>
            </div>
          </div>
        </div>
      `;
      return html;
    }

    // Utility: Convert number to words
    function numberToWords(num) {
      if (!Number.isFinite(num) || num < 0) return 'Invalid Amount';
      if (num === 0) return 'Zero Rupees Only';
      const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
      function convertLessThanThousand(n) {
        if (n === 0) return '';
        if (n < 10) return ones[n];
        if (n < 20) return teens[n - 10];
        const ten = Math.floor(n / 10);
        const unit = n % 10;
        return tens[ten] + (unit ? ' ' + ones[unit] : '');
      }
      let words = '';
      const crore = Math.floor(num / 10000000);
      num %= 10000000;
      const lakh = Math.floor(num / 100000);
      num %= 100000;
      const thousand = Math.floor(num / 1000);
      num %= 1000;
      const hundreds = Math.floor(num);
      if (crore) words += convertLessThanThousand(crore) + ' Crore ';
      if (lakh) words += convertLessThanThousand(lakh) + ' Lakh ';
      if (thousand) words += convertLessThanThousand(thousand) + ' Thousand ';
      if (hundreds) words += convertLessThanThousand(hundreds);
      return words.trim() + ' Rupees Only';
    }

    // Utility: Detect if on mobile device
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Utility: Format timestamp
    function formatTimestamp(date) {
      const options = {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true,
        timeZone: 'Asia/Kolkata',
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      };
      return date.toLocaleString('en-IN', options) + ' IST';
    }

    // Generate and download PDF
    async function downloadInvoicePDF(invoiceId) {
      try {
        if (!db) {
          throw new Error('Firestore database is not initialized.');
        }

        console.log(`Fetching invoice data for ID: ${invoiceId}`);
        const docRef = doc(db, 'invoices', invoiceId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
          throw new Error(`Invoice with ID ${invoiceId} not found.`);
        }

        const invoiceData = docSnap.data();
        console.log('Invoice data fetched:', invoiceData);
        if (!invoiceData || !invoiceData.invoiceNo || !Array.isArray(invoiceData.items)) {
          throw new Error('Invalid or incomplete invoice data.');
        }

        // Calculate totals
        const items = invoiceData.items;
        let totalBeforeTax = 0;
        let totalSGST = 0;
        let totalCGST = 0;
        let totalIGST = 0;

        items.forEach(item => {
          const taxableValue = parseFloat(item.taxableValue) || 0;
          const sgstRate = parseFloat(item.sgstRate) || 0;
          const cgstRate = parseFloat(item.cgstRate) || 0;
          const igstRate = parseFloat(item.igstRate) || 0;
          const sgstAmt = taxableValue * sgstRate / 100 || 0;
          const cgstAmt = taxableValue * cgstRate / 100 || 0;
          const igstAmt = taxableValue * igstRate / 100 || 0;
          totalBeforeTax += taxableValue;
          totalSGST += sgstAmt;
          totalCGST += cgstAmt;
          totalIGST += igstAmt;

          if (item.subItems && Array.isArray(item.subItems)) {
            item.subItems.forEach(subItem => {
              const subTaxableValue = parseFloat(subItem.taxableValue) || 0;
              const subSgstAmt = subTaxableValue * sgstRate / 100 || 0;
              const subCgstAmt = subTaxableValue * cgstRate / 100 || 0;
              const subIgstAmt = subTaxableValue * igstRate / 100 || 0;
              totalBeforeTax += subTaxableValue;
              totalSGST += subSgstAmt;
              totalCGST += subCgstAmt;
              totalIGST += subIgstAmt;
            });
          }
        });

        const grossTotal = totalBeforeTax + totalSGST + totalCGST + totalIGST;
        const roundedTotal = Math.round(grossTotal);
        const rounding = roundedTotal - grossTotal;
        const totals = {
          totalBeforeTax,
          totalSGST,
          totalCGST,
          totalIGST,
          rounding,
          roundedTotal
        };
        console.log('Calculated totals:', totals);

        // Generate PDF
        const pdfContainer = document.getElementById('pdf-container');
        if (!pdfContainer) {
          throw new Error('PDF container element not found in DOM.');
        }

        console.log('Generating PDF HTML content');
        pdfContainer.innerHTML = generateInvoiceHTML(invoiceData, totals);
        const pdfElement = pdfContainer.firstElementChild;
        if (!pdfElement) {
          throw new Error('Failed to generate invoice HTML content.');
        }

        const opt = {
          margin: 5,
          filename: `Invoice_${invoiceData.invoiceNo}.pdf`,
          image: { type: 'jpeg', quality: 0.8 },
          html2canvas: { scale: isMobileDevice() ? 1 : 2, logging: false },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        console.log('Generating PDF with html2pdf.js');
        let pdf;
        try {
          pdf = await html2pdf().set(opt).from(pdfElement).output('blob');
        } catch (pdfError) {
          throw new Error(`PDF generation failed: ${pdfError.message}`);
        }

        if (!pdf) {
          throw new Error('PDF generation returned no data.');
        }

        // Download PDF
        console.log('Initiating PDF download');
        const blobUrl = URL.createObjectURL(pdf);
        const downloadLink = document.createElement('a');
        downloadLink.href = blobUrl;
        downloadLink.download = opt.filename;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(blobUrl);

        alert('PDF has been downloaded successfully.');

        // Clean up
        pdfContainer.innerHTML = '';
      } catch (error) {
        console.error('Error in downloadInvoicePDF:', error);
        alert(`Failed to download PDF: ${error.message}. Please try again.`);
      }
    }

    // Generate and send PDF via Gmail
    async function sendInvoiceViaGmail(invoiceId) {
      try {
        if (!db) {
          throw new Error('Firestore database is not initialized.');
        }

        console.log(`Fetching invoice data for Gmail send, ID: ${invoiceId}`);
        const docRef = doc(db, 'invoices', invoiceId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
          throw new Error(`Invoice with ID ${invoiceId} not found.`);
        }

        const invoiceData = docSnap.data();
        console.log('Invoice data for Gmail:', invoiceData);
        if (!invoiceData || !invoiceData.invoiceNo || !Array.isArray(invoiceData.items)) {
          throw new Error('Invalid or incomplete invoice data.');
        }

        // Calculate totals
        const items = invoiceData.items;
        let totalBeforeTax = 0;
        let totalSGST = 0;
        let totalCGST = 0;
        let totalIGST = 0;

        items.forEach(item => {
          const taxableValue = parseFloat(item.taxableValue) || 0;
          const sgstRate = parseFloat(item.sgstRate) || 0;
          const cgstRate = parseFloat(item.cgstRate) || 0;
          const igstRate = parseFloat(item.igstRate) || 0;
          const sgstAmt = taxableValue * sgstRate / 100 || 0;
          const cgstAmt = taxableValue * cgstRate / 100 || 0;
          const igstAmt = taxableValue * igstRate / 100 || 0;
          totalBeforeTax += taxableValue;
          totalSGST += sgstAmt;
          totalCGST += cgstAmt;
          totalIGST += igstAmt;

          if (item.subItems && Array.isArray(item.subItems)) {
            item.subItems.forEach(subItem => {
              const subTaxableValue = parseFloat(subItem.taxableValue) || 0;
              const subSgstAmt = subTaxableValue * sgstRate / 100 || 0;
              const subCgstAmt = subTaxableValue * cgstRate / 100 || 0;
              const subIgstAmt = subTaxableValue * igstRate / 100 || 0;
              totalBeforeTax += subTaxableValue;
              totalSGST += subSgstAmt;
              totalCGST += subCgstAmt;
              totalIGST += subIgstAmt;
            });
          }
        });

        const grossTotal = totalBeforeTax + totalSGST + totalCGST + totalIGST;
        const roundedTotal = Math.round(grossTotal);
        const rounding = roundedTotal - grossTotal;
        const totals = {
          totalBeforeTax,
          totalSGST,
          totalCGST,
          totalIGST,
          rounding,
          roundedTotal
        };

        // Generate PDF
        const pdfContainer = document.getElementById('pdf-container');
        if (!pdfContainer) {
          throw new Error('PDF container element not found in DOM.');
        }

        console.log('Generating PDF HTML for Gmail send');
        pdfContainer.innerHTML = generateInvoiceHTML(invoiceData, totals);
        const pdfElement = pdfContainer.firstElementChild;
        if (!pdfElement) {
          throw new Error('Failed to generate invoice HTML content.');
        }

        const opt = {
          margin: 5,
          filename: `Invoice_${invoiceData.invoiceNo}.pdf`,
          image: { type: 'jpeg', quality: 0.8 },
          html2canvas: { scale: isMobileDevice() ? 1 : 2, logging: false },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        console.log('Generating PDF for Gmail send');
        let pdf;
        try {
          pdf = await html2pdf().set(opt).from(pdfElement).output('blob');
        } catch (pdfError) {
          throw new Error(`PDF generation failed: ${pdfError.message}`);
        }

        if (!pdf) {
          throw new Error('PDF generation returned no data.');
        }

        // Download PDF
        console.log('Initiating PDF download before Gmail send');
        const blobUrl = URL.createObjectURL(pdf);
        const downloadLink = document.createElement('a');
        downloadLink.href = blobUrl;
        downloadLink.download = opt.filename;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(blobUrl);

        // Open Gmail compose window
        const recipient = encodeURIComponent('saivardhan294@gmail.com');
        const sender = encodeURIComponent('saivardhanbusiness@gmail.com');
        const subject = encodeURIComponent(`Invoice ${invoiceData.invoiceNo} from TRIPZETTA`);
        const body = encodeURIComponent(
          `Dear Sir/Madam,\n\nPlease find attached the invoice ${invoiceData.invoiceNo} for Rs. ${totals.roundedTotal.toFixed(2)}.\n\nThank you for your business!\nTRIPZETTA`
        );
        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${recipient}&from=${sender}&su=${subject}&body=${body}`;

        window.open(gmailUrl, '_blank');
        alert('PDF has been downloaded. Please attach the downloaded PDF in the Gmail compose window and click "Send".');

        // Clean up
        pdfContainer.innerHTML = '';
      } catch (error) {
        console.error('Error in sendInvoiceViaGmail:', error);
        alert(`Failed to generate PDF or open Gmail: ${error.message}. Please try again or manually send the downloaded PDF.`);
      }
    }

    const currentYear = new Date().getFullYear();
    const selectYear = document.getElementById('year-select');
    const selectFY = document.getElementById('fy-select');
    const filterYear = document.getElementById('filter-year');
    const filterDay = document.getElementById('filter-day');

    // Populate year dropdowns
    for (let year = currentYear - 5; year <= currentYear + 5; year++) {
      const option = document.createElement('option');
      option.value = year;
      option.text = year;
      if (year === currentYear) option.selected = true;
      selectYear.appendChild(option);
      const fyOption = document.createElement('option');
      fyOption.value = `${year}-${year + 1}`;
      fyOption.text = `Apr-${year} to Mar-${year + 1}`;
      if (year === currentYear - 1) fyOption.selected = true;
      selectFY.appendChild(fyOption);
      const filterYearOption = document.createElement('option');
      filterYearOption.value = year;
      filterYearOption.text = year;
      filterYear.appendChild(filterYearOption);
    }

    // Populate day dropdown
    for (let day = 1; day <= 31; day++) {
      const option = document.createElement('option');
      option.value = day;
      option.text = day;
      filterDay.appendChild(option);
    }

    async function cancelInvoice(invoiceId) {
      const password = prompt('Enter password to cancel/undo cancel invoice:');
      if (password === 'vardhan') {
        try {
          const docRef = doc(db, 'invoices', invoiceId);
          const docSnap = await getDoc(docRef);
          const newStatus = docSnap.data().status === 'canceled' ? 'active' : 'canceled';
          await setDoc(docRef, { status: newStatus }, { merge: true });
          alert(`Invoice ${newStatus === 'canceled' ? 'canceled' : 'reactivated'} successfully.`);
          updateDashboard();
        } catch (error) {
          console.error('Error updating invoice status:', error);
          alert('Failed to update invoice status.');
        }
      } else {
        alert('Incorrect password.');
      }
    }

    async function editInvoice(invoiceId) {
      window.location.href = `create-invoice.html?invoiceId=${invoiceId}`;
    }

    async function updateDashboard() {
      if (!db) {
        alert('Firestore is not initialized.');
        return;
      }
      const selectedMonth = parseInt(document.getElementById('month-select').value);
      const selectedYear = parseInt(document.getElementById('year-select').value);
      const selectedFY = document.getElementById('fy-select').value;
      const [fyStart, fyEnd] = selectedFY.split('-').map(Number);
      const searchQuery = document.getElementById('search-input').value.trim().toLowerCase();
      const filterDay = document.getElementById('filter-day').value;
      const filterMonth = document.getElementById('filter-month').value;
      const filterYear = parseInt(document.getElementById('filter-year').value);
      let monthlyInvoices = 0;
      let monthlySubtotal = 0;
      let monthlyGST = 0;
      let monthlyEarnings = 0;
      let monthlyPending = 0;
      let yearlyInvoices = 0;
      let yearlySubtotal = 0;
      let yearlyGST = 0;
      let yearlyEarnings = 0;
      let yearlyPending = 0;
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const selectedMonthName = monthNames[selectedMonth - 1];
      const invoiceListBody = document.getElementById('invoice-list-body');
      invoiceListBody.innerHTML = '';
      try {
        console.log('Fetching invoices from Firestore');
        const querySnapshot = await getDocs(collection(db, 'invoices'));
        const invoices = [];
        querySnapshot.forEach(doc => {
          invoices.push({ id: doc.id, ...doc.data() });
        });
        console.log(`Fetched ${invoices.length} invoices`);
        invoices.forEach(invoice => {
          if (!invoice || !invoice.date || !Array.isArray(invoice.items)) return;
          const invoiceDate = new Date(invoice.date);
          if (isNaN(invoiceDate.getTime())) return;
          const invoiceDay = invoiceDate.getDate();
          const invoiceMonth = invoiceDate.getMonth() + 1;
          const invoiceYear = invoiceDate.getFullYear();
          const invoiceFY = invoiceMonth >= 4 ? `${invoiceYear}-${invoiceYear + 1}` : `${invoiceYear - 1}-${invoiceYear}`;
          // Apply date filters
          if (filterDay && parseInt(filterDay) !== invoiceDay) return;
          if (filterMonth && parseInt(filterMonth) !== invoiceMonth) return;
          if (filterYear && filterYear !== invoiceYear) return;
          if (searchQuery) {
            const matchesSearch =
              (invoice.invoiceNo || '').toLowerCase().includes(searchQuery) ||
              (invoice.customerName || '').toLowerCase().includes(searchQuery) ||
              (invoice.date || '').toLowerCase().includes(searchQuery);
            if (!matchesSearch) return;
          }
          if (invoice.status !== 'canceled') {
            const subtotal = invoice.items.reduce((sum, item) => {
              const itemValue = parseFloat(item.taxableValue) || 0;
              const subItemsValue = Array.isArray(item.subItems) ?
                item.subItems.reduce((subSum, subItem) => subSum + (parseFloat(subItem.taxableValue) || 0), 0) : 0;
              return sum + itemValue + subItemsValue;
            }, 0);
            const gstTotal = invoice.items.reduce((sum, item) => {
              const sgst = (parseFloat(item.taxableValue) || 0) * (parseFloat(item.sgstRate) || 0) / 100;
              const cgst = (parseFloat(item.taxableValue) || 0) * (parseFloat(item.cgstRate) || 0) / 100;
              const igst = (parseFloat(item.taxableValue) || 0) * (parseFloat(item.igstRate) || 0) / 100;
              const subItemsGST = Array.isArray(item.subItems) ? item.subItems.reduce((subSum, subItem) => {
                const subSGST = (parseFloat(subItem.taxableValue) || 0) * (parseFloat(item.sgstRate) || 0) / 100;
                const subCGST = (parseFloat(subItem.taxableValue) || 0) * (parseFloat(item.cgstRate) || 0) / 100;
                const subIGST = (parseFloat(subItem.taxableValue) || 0) * (parseFloat(item.igstRate) || 0) / 100;
                return subSum + subSGST + subCGST + subIGST;
              }, 0) : 0;
              return sum + sgst + cgst + igst + subItemsGST;
            }, 0);
            const earnings = subtotal + gstTotal;
            const pending = earnings;
            if (invoiceMonth === selectedMonth && invoiceYear === selectedYear) {
              monthlyInvoices++;
              monthlySubtotal += subtotal;
              monthlyGST += gstTotal;
              monthlyEarnings += earnings;
              monthlyPending += pending;
            }
            if (invoiceFY === selectedFY) {
              yearlyInvoices++;
              yearlySubtotal += subtotal;
              yearlyGST += gstTotal;
              yearlyEarnings += earnings;
              yearlyPending += pending;
            }
          }
          const row = document.createElement('tr');
          if (invoice.status === 'canceled') row.classList.add('canceled-row');
          const status = invoice.status === 'canceled' ? 'Canceled' : 'Active';
          row.innerHTML = `
            <td>${sanitizeHTML(invoice.invoiceNo)}</td>
            <td>${sanitizeHTML(invoice.date)}</td>
            <td>${sanitizeHTML(invoice.customerName)}</td>
            <td>Rs. ${invoice.total.toLocaleString('en-IN')}</td>
            <td>${status}</td>
            <td>
              <button class="action-btn view-btn" data-id="${invoice.id}">View</button>
              <button class="action-btn print-btn" data-id="${invoice.id}">Download PDF</button>
              <button class="edit-btn" data-id="${invoice.id}">Edit</button>
              <button class="cancel-btn" data-id="${invoice.id}">${status === 'Canceled' ? 'Undo Cancel' : 'Cancel'}</button>
              <button class="gmail-btn" data-id="${invoice.id}">Gmail</button>
            </td>
          `;
          invoiceListBody.appendChild(row);
        });
        document.querySelectorAll('.view-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            window.location.href = `invoice-preview.html?invoiceId=${invoiceId}`;
          });
        });
        document.querySelectorAll('.print-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            downloadInvoicePDF(invoiceId);
          });
        });
        document.querySelectorAll('.edit-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            editInvoice(invoiceId);
          });
        });
        document.querySelectorAll('.cancel-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            cancelInvoice(invoiceId);
          });
        });
        document.querySelectorAll('.gmail-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            sendInvoiceViaGmail(invoiceId);
          });
        });
        document.getElementById('monthly-value').innerText = monthlyInvoices;
        document.getElementById('subtotal-monthly').innerText = `Rs. ${monthlySubtotal.toLocaleString('en-IN')}`;
        document.getElementById('gst-monthly').innerText = `Rs. ${monthlyGST.toFixed(2)}`;
        document.getElementById('earnings-monthly').innerText = `Rs. ${monthlyEarnings.toLocaleString('en-IN')}`;
        document.getElementById('pending-monthly').innerText = `Rs. ${monthlyPending.toLocaleString('en-IN')}`;
        document.querySelectorAll('.stat-box.monthly h3').forEach(h3 => {
          h3.innerText = h3.innerText.replace(/\(.*?\)/, `(${selectedMonthName}-${selectedYear})`);
        });
        document.getElementById('yearly-value').innerText = yearlyInvoices;
        document.getElementById('subtotal-yearly').innerText = `Rs. ${yearlySubtotal.toLocaleString('en-IN')}`;
        document.getElementById('gst-yearly').innerText = `Rs. ${yearlyGST.toFixed(2)}`;
        document.getElementById('earnings-yearly').innerText = `Rs. ${yearlyEarnings.toLocaleString('en-IN')}`;
        document.getElementById('pending-yearly').innerText = `Rs. ${yearlyPending.toFixed(2)}`;
        document.querySelectorAll('.stat-box.yearly h3').forEach(h3 => {
          h3.innerText = h3.innerText.replace(/\(.*?\)/, `(${fyStart}-${fyEnd})`);
        });
      } catch (error) {
        console.error('Error fetching invoices:', error);
        alert('Failed to load dashboard data.');
      }
    }

    async function downloadReport() {
      const selectedMonth = document.getElementById('month-select').options[document.getElementById('month-select').selectedIndex].text;
      const selectedYear = document.getElementById('year-select').value;
      const selectedFY = document.getElementById('fy-select').value;
      const report = `
Dashboard Report
Generated on: ${formatTimestamp(new Date())}
Month: ${selectedMonth}-${selectedYear}
Invoices: ${document.getElementById('monthly-value').textContent}
Subtotal: ${document.getElementById('subtotal-monthly').textContent}
GST Total: ${document.getElementById('gst-monthly').textContent}
Earnings: ${document.getElementById('earnings-monthly').textContent}
Pending: ${document.getElementById('pending-monthly').textContent}
Financial Year: ${selectedFY}
Invoices: ${document.getElementById('yearly-value').textContent}
Subtotal: ${document.getElementById('subtotal-yearly').textContent}
GST Total: ${document.getElementById('gst-yearly').textContent}
Earnings: ${document.getElementById('earnings-yearly').textContent}
Pending: ${document.getElementById('pending-yearly').textContent}
      `;
      const blob = new Blob([report], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'dashboard-report.txt';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    document.getElementById('filter-btn').addEventListener('click', updateDashboard);
    document.getElementById('search-btn').addEventListener('click', updateDashboard);
    document.getElementById('clear-search-btn').addEventListener('click', () => {
      document.getElementById('search-input').value = '';
      updateDashboard();
    });
    document.getElementById('apply-filter-btn').addEventListener('click', updateDashboard);
    document.getElementById('clear-filter-btn').addEventListener('click', () => {
      document.getElementById('filter-day').value = '';
      document.getElementById('filter-month').value = '';
      document.getElementById('filter-year').value = '';
      updateDashboard();
    });

    updateDashboard();
  </script>
</body>
</html>