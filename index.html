<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Invoice Generator Dashboard</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #ddd;
      margin: 0 5px;
      border-radius: 5px;
      text-decoration: none;
      color: black;
    }
    .tab.active {
      background: #007bff;
      color: white;
    }
    .dashboard {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border: 1px solid #ccc;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .dashboard-header select, .dashboard-header button {
      padding: 5px;
      margin: 5px;
    }
    .search-container {
      margin-bottom: 15px;
    }
    .search-container input {
      padding: 5px;
      width: 200px;
      margin-right: 10px;
    }
    .search-container button {
      padding: 5px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .search-container #clear-search-btn {
      background: #ff4d4d;
    }
    .filter-container {
      margin-bottom: 15px;
    }
    .filter-container select, .filter-container input {
      padding: 5px;
      margin-right: 10px;
    }
    .stats {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .stat-box {
      width: 18%;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: center;
      background: #f9f9f9;
    }
    .stat-box.monthly { background: #e6f7ff; }
    .stat-box.yearly { background: #fffbe6; }
    .stat-box h3 { margin: 0; font-size: 16px; }
    .stat-box p { margin: 5px 0 0; font-size: 20px; font-weight: bold; }
    .download-report-btn {
      display: block;
      width: 200px;
      margin: 20px auto;
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .invoice-list {
      margin-top: 20px;
    }
    .invoice-list table {
      width: 100%;
      border-collapse: collapse;
    }
    .invoice-list th, .invoice-list td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .invoice-list th {
      background-color: #f2f2f2;
    }
    .action-btn, .cancel-btn, .edit-btn {
      padding: 5px 10px;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 5px;
    }
    .action-btn { background: #007bff; }
    .cancel-btn { background: #ff8c00; }
    .edit-btn { background: #4CAF50; }
    .canceled-row { color: #888; }
    @media screen and (max-width: 768px) {
      .dashboard { padding: 10px; }
      .stat-box { width: 48%; }
      .search-container input { width: 150px; }
      .filter-container select, .filter-container input { width: 100px; }
      table { font-size: 8px; }
    }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" data-tab="services">Dashboard</div>
    <a class="tab" href="invoice.html">Purchase Records</a>
    <a class="tab" href="create-invoice.html">Create Invoice</a>
    <a class="tab" href="invoice-preview.html">Invoice Preview</a>
  </div>

  <div class="dashboard" id="services">
    <h2>Dashboard</h2>
    <div class="dashboard-header">
      <div>
        <label for="month-select">Select Month:</label>
        <select id="month-select">
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5" selected>May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
        <label for="year-select">Select Year:</label>
        <select id="year-select"></select>
        <label for="fy-select">Select Financial Year:</label>
        <select id="fy-select"></select>
        <button id="filter-btn">Filter</button>
      </div>
    </div>
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search by invoice no, customer name, or date">
      <button id="search-btn">Search</button>
      <button id="clear-search-btn">Clear</button>
    </div>
    <h3>Month-wise:</h3>
    <div class="stats">
      <div class="stat-box monthly">
        <h3>Invoices (May-2025)</h3>
        <p id="monthly-value">0</p>
      </div>
      <div class="stat-box monthly">
        <h3>Subtotal (May-2025)</h3>
        <p id="subtotal-monthly">Rs. 0</p>
      </div>
      <div class="stat-box monthly">
        <h3>GST Total (May-2025)</h3>
        <p id="gst-monthly">Rs. 0</p>
      </div>
      <div class="stat-box monthly">
        <h3>Earnings (May-2025)</h3>
        <p id="earnings-monthly">Rs. 0</p>
      </div>
      <div class="stat-box monthly">
        <h3>Pending (Rs.)</h3>
        <p id="pending-monthly">Rs. 0</p>
      </div>
    </div>
    <h3>Yearly:</h3>
    <div class="stats">
      <div class="stat-box yearly">
        <h3>Invoices (2024-2025)</h3>
        <p id="yearly-value">0</p>
      </div>
      <div class="stat-box yearly">
        <h3>Subtotal (2024-2025)</h3>
        <p id="subtotal-yearly">Rs. 0</p>
      </div>
      <div class="stat-box yearly">
        <h3>GST Total (2024-2025)</h3>
        <p id="gst-yearly">Rs. 0</p>
      </div>
      <div class="stat-box yearly">
        <h3>Earnings (2024-2025)</h3>
        <p id="earnings-yearly">Rs. 0</p>
      </div>
      <div class="stat-box yearly">
        <h3>Pending (Rs.)</h3>
        <p id="pending-yearly">0</p>
      </div>
    </div>
    <div class="filter-container">
      <select id="filter-day">
        <option value="">All Days</option>
        <!-- Days will be populated dynamically -->
      </select>
      <select id="filter-month">
        <option value="">All Months</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      <select id="filter-year">
        <option value="">All Years</option>
        <!-- Years will be populated dynamically -->
      </select>
      <button id="apply-filter-btn">Apply Filter</button>
      <button id="clear-filter-btn">Clear Filters</button>
    </div>
    <h3>Invoice List</h3>
    <div class="invoice-list">
      <table>
        <thead>
          <tr>
            <th>Invoice No</th>
            <th>Date</th>
            <th>Customer Name</th>
            <th>Total (INR)</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="invoice-list-body"></tbody>
      </table>
    </div>
    <button class="download-report-btn" onclick="downloadReport()">Download Report</button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAT3oqplHoUuZrDNpnZbQ-hoUChLLEdmV4",
      authDomain: "saas-restaurant-vardhan.firebaseapp.com",
      projectId: "saas-restaurant-vardhan",
      storageBucket: "saas-restaurant-vardhan.appspot.com",
      messagingSenderId: "1019077493371",
      appId: "1:1019077493371:web:2c92f2c902e34b05c358de"
    };

    let db;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (error) {
      console.error('Error initializing Firebase:', error);
      alert('Failed to initialize Firebase. Please check your configuration.');
    }

    const currentYear = new Date().getFullYear();
    const selectYear = document.getElementById('year-select');
    const selectFY = document.getElementById('fy-select');
    const filterYear = document.getElementById('filter-year');
    const filterDay = document.getElementById('filter-day');

    // Populate year dropdowns
    for (let year = currentYear - 5; year <= currentYear + 5; year++) {
      const option = document.createElement('option');
      option.value = year;
      option.text = year;
      if (year === currentYear) option.selected = true;
      selectYear.appendChild(option);
      const fyOption = document.createElement('option');
      fyOption.value = `${year}-${year + 1}`;
      fyOption.text = `Apr-${year} to Mar-${year + 1}`;
      if (year === currentYear - 1) fyOption.selected = true;
      selectFY.appendChild(fyOption);
      const filterYearOption = document.createElement('option');
      filterYearOption.value = year;
      filterYearOption.text = year;
      filterYear.appendChild(filterYearOption);
    }

    // Populate day dropdown
    for (let day = 1; day <= 31; day++) {
      const option = document.createElement('option');
      option.value = day;
      option.text = day;
      filterDay.appendChild(option);
    }

    async function cancelInvoice(invoiceId) {
      const password = prompt('Enter password to cancel/undo cancel invoice:');
      if (password === 'vardhan') {
        try {
          const docRef = doc(db, 'invoices', invoiceId);
          const docSnap = await getDoc(docRef);
          const newStatus = docSnap.data().status === 'canceled' ? 'active' : 'canceled';
          await setDoc(docRef, { status: newStatus }, { merge: true });
          alert(`Invoice ${newStatus === 'canceled' ? 'canceled' : 'reactivated'} successfully.`);
          updateDashboard();
        } catch (error) {
          console.error('Error updating invoice status:', error);
          alert('Failed to update invoice status.');
        }
      } else {
        alert('Incorrect password.');
      }
    }

    async function editInvoice(invoiceId) {
      window.location.href = `create-invoice.html?invoiceId=${invoiceId}`;
    }

    async function updateDashboard() {
      if (!db) {
        alert('Firestore is not initialized.');
        return;
      }
      const selectedMonth = parseInt(document.getElementById('month-select').value);
      const selectedYear = parseInt(document.getElementById('year-select').value);
      const selectedFY = document.getElementById('fy-select').value;
      const [fyStart, fyEnd] = selectedFY.split('-').map(Number);
      const searchQuery = document.getElementById('search-input').value.trim().toLowerCase();
      const filterDay = document.getElementById('filter-day').value;
      const filterMonth = document.getElementById('filter-month').value;
      const filterYear = document.getElementById('filter-year').value;
      let monthlyInvoices = 0;
      let monthlySubtotal = 0;
      let monthlyGST = 0;
      let monthlyEarnings = 0;
      let monthlyPending = 0;
      let yearlyInvoices = 0;
      let yearlySubtotal = 0;
      let yearlyGST = 0;
      let yearlyEarnings = 0;
      let yearlyPending = 0;
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const selectedMonthName = monthNames[selectedMonth - 1];
      const invoiceListBody = document.getElementById('invoice-list-body');
      invoiceListBody.innerHTML = '';
      try {
        const querySnapshot = await getDocs(collection(db, 'invoices'));
        const invoices = [];
        querySnapshot.forEach(doc => {
          invoices.push({ id: doc.id, ...doc.data() });
        });
        invoices.forEach(invoice => {
          if (!invoice || !invoice.date || !Array.isArray(invoice.items)) return;
          const invoiceDate = new Date(invoice.date);
          if (isNaN(invoiceDate.getTime())) return;
          const invoiceDay = invoiceDate.getDate();
          const invoiceMonth = invoiceDate.getMonth() + 1;
          const invoiceYear = invoiceDate.getFullYear();
          const invoiceFY = invoiceMonth >= 4 ? `${invoiceYear}-${invoiceYear + 1}` : `${invoiceYear - 1}-${invoiceYear}`;
          // Apply date filters
          if (filterDay && parseInt(filterDay) !== invoiceDay) return;
          if (filterMonth && parseInt(filterMonth) !== invoiceMonth) return;
          if (filterYear && parseInt(filterYear) !== invoiceYear) return;
          if (searchQuery) {
            const matchesSearch =
              (invoice.invoiceNo || '').toLowerCase().includes(searchQuery) ||
              (invoice.customerName || '').toLowerCase().includes(searchQuery) ||
              (invoice.date || '').toLowerCase().includes(searchQuery);
            if (!matchesSearch) return;
          }
          if (invoice.status !== 'canceled') {
            const subtotal = invoice.items.reduce((sum, item) => {
              const itemValue = parseFloat(item.taxableValue) || 0;
              const subItemsValue = Array.isArray(item.subItems) ?
                item.subItems.reduce((subSum, subItem) => subSum + (parseFloat(subItem.taxableValue) || 0), 0) : 0;
              return sum + itemValue + subItemsValue;
            }, 0);
            const gstTotal = invoice.items.reduce((sum, item) => {
              const sgst = (parseFloat(item.taxableValue) || 0) * (parseFloat(item.sgstRate) || 0) / 100;
              const cgst = (parseFloat(item.taxableValue) || 0) * (parseFloat(item.cgstRate) || 0) / 100;
              const igst = (parseFloat(item.taxableValue) || 0) * (parseFloat(item.igstRate) || 0) / 100;
              const subItemsGST = Array.isArray(item.subItems) ? item.subItems.reduce((subSum, subItem) => {
                const subSGST = (parseFloat(subItem.taxableValue) || 0) * (parseFloat(item.sgstRate) || 0) / 100;
                const subCGST = (parseFloat(subItem.taxableValue) || 0) * (parseFloat(item.cgstRate) || 0) / 100;
                const subIGST = (parseFloat(subItem.taxableValue) || 0) * (parseFloat(item.igstRate) || 0) / 100;
                return subSum + subSGST + subCGST + subIGST;
              }, 0) : 0;
              return sum + sgst + cgst + igst + subItemsGST;
            }, 0);
            const earnings = subtotal + gstTotal;
            const pending = earnings;
            if (invoiceMonth === selectedMonth && invoiceYear === selectedYear) {
              monthlyInvoices++;
              monthlySubtotal += subtotal;
              monthlyGST += gstTotal;
              monthlyEarnings += earnings;
              monthlyPending += pending;
            }
            if (invoiceFY === selectedFY) {
              yearlyInvoices++;
              yearlySubtotal += subtotal;
              yearlyGST += gstTotal;
              yearlyEarnings += earnings;
              yearlyPending += pending;
            }
          }
          const row = document.createElement('tr');
          if (invoice.status === 'canceled') row.classList.add('canceled-row');
          const status = invoice.status === 'canceled' ? 'Canceled' : 'Active';
          row.innerHTML = `
            <td>${invoice.invoiceNo}</td>
            <td>${invoice.date}</td>
            <td>${invoice.customerName}</td>
            <td>Rs. ${invoice.total.toLocaleString('en-IN')}</td>
            <td>${status}</td>
            <td>
              <button class="action-btn view-btn" data-id="${invoice.id}">View</button>
              <button class="action-btn print-btn" data-id="${invoice.id}">Print</button>
              <button class="edit-btn" data-id="${invoice.id}">Edit</button>
              <button class="cancel-btn" data-id="${invoice.id}">${status === 'Canceled' ? 'Undo Cancel' : 'Cancel'}</button>
            </td>
          `;
          invoiceListBody.appendChild(row);
        });
        document.querySelectorAll('.view-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            window.location.href = `invoice-preview.html?invoiceId=${invoiceId}`;
          });
        });
        document.querySelectorAll('.print-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            window.location.href = `invoice-preview.html?invoiceId=${invoiceId}&print=true`;
          });
        });
        document.querySelectorAll('.edit-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            editInvoice(invoiceId);
          });
        });
        document.querySelectorAll('.cancel-btn').forEach(button => {
          button.addEventListener('click', () => {
            const invoiceId = button.getAttribute('data-id');
            cancelInvoice(invoiceId);
          });
        });
        document.getElementById('monthly-value').innerText = monthlyInvoices;
        document.getElementById('subtotal-monthly').innerText = `Rs. ${monthlySubtotal.toLocaleString('en-IN')}`;
        document.getElementById('gst-monthly').innerText = `Rs. ${monthlyGST.toFixed(2)}`;
        document.getElementById('earnings-monthly').innerText = `Rs. ${monthlyEarnings.toLocaleString('en-IN')}`;
        document.getElementById('pending-monthly').innerText = `Rs. ${monthlyPending.toLocaleString('en-IN')}`;
        document.querySelectorAll('.stat-box.monthly h3').forEach(h3 => {
          h3.innerText = h3.innerText.replace(/\(.*?\)/, `(${selectedMonthName}-${selectedYear})`);
        });
        document.getElementById('yearly-value').innerText = yearlyInvoices;
        document.getElementById('subtotal-yearly').innerText = `Rs. ${yearlySubtotal.toLocaleString('en-IN')}`;
        document.getElementById('gst-yearly').innerText = `Rs. ${yearlyGST.toFixed(2)}`;
        document.getElementById('earnings-yearly').innerText = `Rs. ${yearlyEarnings.toLocaleString('en-IN')}`;
        document.getElementById('pending-yearly').innerText = `Rs. ${yearlyPending.toFixed(2)}`;
        document.querySelectorAll('.stat-box.yearly h3').forEach(h3 => {
          h3.innerText = h3.innerText.replace(/\(.*?\)/, `(${fyStart}-${fyEnd})`);
        });
      } catch (error) {
        console.error('Error fetching invoices:', error);
        alert('Failed to load dashboard data.');
      }
    }

    async function downloadReport() {
      const selectedMonth = document.getElementById('month-select').options[document.getElementById('month-select').selectedIndex].text;
      const selectedYear = document.getElementById('year-select').value;
      const selectedFY = document.getElementById('fy-select').value;
      const report = `
Dashboard Report
Month: ${selectedMonth}-${selectedYear}
Invoices: ${document.getElementById('monthly-value').textContent}
Subtotal: ${document.getElementById('subtotal-monthly').textContent}
GST Total: ${document.getElementById('gst-monthly').textContent}
Earnings: ${document.getElementById('earnings-monthly').textContent}
Pending: ${document.getElementById('pending-monthly').textContent}
Financial Year: ${selectedFY}
Invoices: ${document.getElementById('yearly-value').textContent}
Subtotal: ${document.getElementById('subtotal-yearly').textContent}
GST Total: ${document.getElementById('gst-yearly').textContent}
Earnings: ${document.getElementById('earnings-yearly').textContent}
Pending: ${document.getElementById('pending-yearly').textContent}
      `;
      const blob = new Blob([report], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'dashboard-report.txt';
      link.click();
    }

    document.getElementById('filter-btn').addEventListener('click', updateDashboard);
    document.getElementById('search-btn').addEventListener('click', updateDashboard);
    document.getElementById('clear-search-btn').addEventListener('click', () => {
      document.getElementById('search-input').value = '';
      updateDashboard();
    });
    document.getElementById('apply-filter-btn').addEventListener('click', updateDashboard);
    document.getElementById('clear-filter-btn').addEventListener('click', () => {
      document.getElementById('filter-day').value = '';
      document.getElementById('filter-month').value = '';
      document.getElementById('filter-year').value = '';
      updateDashboard();
    });

    updateDashboard();
  </script>
</body>
</html>